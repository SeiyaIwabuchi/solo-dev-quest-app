# Feature Specification: User Authentication

**Feature Branch**: `001-user-auth`  
**Created**: 2025-11-01  
**Status**: Draft  
**Input**: User description: "Firebase Authentication integration with email/password and Google Sign-In for user registration and login"

## Clarifications

### Session 2025-11-01

- Q: セキュリティ - パスワード保存とトークン管理: クライアント側での認証トークンの保存方法とセキュリティ対策は？ → A: OSのセキュアストレージ（iOS Keychain、Android Keystore）を使用してトークンを保存
- Q: ログイン試行回数制限とアカウントロック: ブルートフォース攻撃対策として、連続ログイン失敗時の制限は？ → A: 5回連続失敗で15分間アカウントロック（業界標準）
- Q: パスワードリセットリンクの有効期限: パスワードリセットメールのリンクはどのくらいの期間有効にするか？ → A: 1時間有効（セキュリティとユーザビリティのバランス、Firebase デフォルト）
**Q4: セッション有効期限**
- Question: ユーザーセッションはどのくらいの期間有効とすべきか?
- Answer: 30日間のセッション有効期限を設定。最終アクセスから30日経過後は再ログインを要求する。
- Rationale: セキュリティと利便性のバランス。長期的なアクセス維持とセキュリティリスク軽減の両立。

**Q5: Googleサインイン失敗時のフォールバック**
- Question: Googleサインインが利用できない場合(サービス障害等)のフォールバック戦略は?
- Answer: エラーメッセージを表示し、代替手段としてメール/パスワード認証への誘導を提供する。
- Rationale: サービス継続性の確保とユーザーアクセス保証。外部サービス依存のリスク軽減。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - New User Registration (Priority: P1)

新規ユーザーが自分のメールアドレスとパスワードでアカウントを作成し、個人開発支援アプリを利用開始できる。

**Why this priority**: アプリのすべての機能はユーザーアカウントが前提となるため、最も基本的かつ必須の機能。ユーザーがアカウントを作成できなければ、他のどの機能も利用できない。

**Independent Test**: 新規ユーザーが登録フォームからメールアドレスとパスワードを入力して送信し、アカウントが作成され、アプリのホーム画面にアクセスできることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 未登録のユーザーがアプリを開いた状態で、**When** 「新規登録」ボタンをタップし、有効なメールアドレス（例: user@example.com）と8文字以上のパスワードを入力して「登録」ボタンを押す、**Then** アカウントが作成され、自動的にログイン状態となり、ホーム画面が表示される
2. **Given** 登録画面でメールアドレス欄に入力した状態で、**When** 無効な形式のメールアドレス（例: "invalid-email"）を入力して「登録」ボタンを押す、**Then** エラーメッセージ「有効なメールアドレスを入力してください」が表示され、アカウントは作成されない
3. **Given** 登録画面でパスワード欄に入力した状態で、**When** 7文字以下のパスワード（例: "pass123"）を入力して「登録」ボタンを押す、**Then** エラーメッセージ「パスワードは8文字以上で入力してください」が表示され、アカウントは作成されない
4. **Given** 既に登録済みのメールアドレスで登録を試みた状態で、**When** 既存のメールアドレスとパスワードを入力して「登録」ボタンを押す、**Then** エラーメッセージ「このメールアドレスは既に使用されています」が表示され、新規アカウントは作成されない

---

### User Story 2 - Existing User Login (Priority: P1)

既存ユーザーが登録済みのメールアドレスとパスワードでログインし、アプリに再アクセスできる。

**Why this priority**: 新規登録と同等に重要。ユーザーがアプリを閉じて再度開いた際、またはログアウト後に再度アクセスする際に必須の機能。

**Independent Test**: 既存のアカウント情報（メールアドレスとパスワード）を入力してログインボタンを押し、認証が成功してホーム画面にアクセスできることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 登録済みユーザーがログイン画面を開いた状態で、**When** 正しいメールアドレスとパスワードを入力して「ログイン」ボタンを押す、**Then** 認証が成功し、ホーム画面が表示される
2. **Given** ログイン画面でメールアドレスとパスワードを入力した状態で、**When** 誤ったパスワードを入力して「ログイン」ボタンを押す、**Then** エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示され、ログインできない
3. **Given** ログイン画面が表示された状態で、**When** Googleサインインボタンをタップしたが、Googleサービスが利用不可の場合、**Then** エラーメッセージ「Googleサインインは現在利用できません。メール/パスワード認証をご利用ください」が表示され、通常のログインフォームへの誘導が提供される

---
3. **Given** ログイン画面でメールアドレスを入力した状態で、**When** 登録されていないメールアドレスとパスワードを入力して「ログイン」ボタンを押す、**Then** エラーメッセージ「メールアドレスまたはパスワードが正しくありません」が表示され、ログインできない
4. **Given** ログイン画面を開いた状態で、**When** メールアドレスまたはパスワードを空欄のまま「ログイン」ボタンを押す、**Then** エラーメッセージ「すべての項目を入力してください」が表示され、ログインできない

---

### User Story 3 - Google Sign-In (Priority: P2)

ユーザーがGoogleアカウントを使用してワンタップで新規登録またはログインできる。

**Why this priority**: メールアドレス/パスワード認証が実装されていれば基本的な認証フローは完成するため、P2優先度。ただし、ユーザーの利便性を大幅に向上させるため、MVP完成後すぐに追加すべき機能。

**Independent Test**: 「Googleでログイン」ボタンをタップし、Googleアカウント選択画面で認証を完了後、アプリのホーム画面にアクセスできることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** 新規ユーザーがログイン/登録画面を開いた状態で、**When** 「Googleでログイン」ボタンをタップし、Googleアカウントを選択して認証を許可する、**Then** 新規アカウントが自動的に作成され、ログイン状態でホーム画面が表示される
2. **Given** 既にGoogleアカウントで登録済みのユーザーがログイン画面を開いた状態で、**When** 「Googleでログイン」ボタンをタップし、同じGoogleアカウントを選択して認証を許可する、**Then** ログインが成功し、ホーム画面が表示される
3. **Given** Googleログイン画面が表示された状態で、**When** ユーザーが認証をキャンセルする、**Then** ログイン/登録画面に戻り、エラーメッセージなしで元の状態に戻る
4. **Given** ログイン画面でGoogleサインインを試みた状態で、**When** Googleサービスが障害等で利用不可の場合、**Then** エラーメッセージ「Googleサインインは現在利用できません。メール/パスワード認証をご利用ください」が表示され、通常ログインフォームへの明確な誘導が提供される

---

### User Story 4 - Password Reset (Priority: P2)

ユーザーがパスワードを忘れた場合、メールアドレスを使用してパスワードをリセットできる。

**Why this priority**: ユーザーがパスワードを忘れた際にアカウントにアクセスできなくなるのを防ぐ重要な機能だが、新規登録・ログインが動作していれば最初のユーザーテストは可能なため、P2優先度。

**Independent Test**: ログイン画面から「パスワードを忘れた」リンクをタップし、登録済みメールアドレスを入力してリセットメールを受信し、新しいパスワードでログインできることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ログイン画面で「パスワードを忘れた」リンクをタップした状態で、**When** 登録済みのメールアドレスを入力して「リセットメールを送信」ボタンを押す、**Then** パスワードリセット用のメールが送信され、「メールを送信しました」という確認メッセージが表示される
2. **Given** パスワードリセットメールを受信した状態で、**When** メール内のリセットリンク（1時間有効）をタップし、新しいパスワード（8文字以上）を2回入力して「パスワードを変更」ボタンを押す、**Then** パスワードが更新され、「パスワードが変更されました」というメッセージが表示され、新しいパスワードでログインできる
3. **Given** パスワードリセット画面を開いた状態で、**When** 登録されていないメールアドレスを入力して「リセットメールを送信」ボタンを押す、**Then** セキュリティ上の理由から「メールを送信しました」というメッセージが表示される（実際にはメールは送信されない）
4. **Given** パスワードリセットメールを受信してから1時間以上経過した状態で、**When** 期限切れのリセットリンクをタップする、**Then** 「このリンクは期限切れです。再度パスワードリセットを申請してください」というエラーメッセージが表示される

---

### User Story 5 - Persistent Login (Priority: P3)

ユーザーがアプリを閉じて再度開いた際、自動的にログイン状態が維持される。

**Why this priority**: ユーザー体験を向上させる重要な機能だが、毎回ログインすることで基本機能のテストは可能なため、P3優先度。実装は比較的容易で、後から追加しやすい。

**Independent Test**: ログイン後にアプリを完全に終了し、再度アプリを起動した際に、ログイン画面をスキップして直接ホーム画面が表示されることで独立してテスト可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがログインしてアプリを使用している状態で、**When** アプリを完全に終了し、30日以内に再度アプリを起動する、**Then** ログイン画面をスキップして自動的にホーム画面が表示される
2. **Given** ユーザーが「ログアウト」機能を使用してログアウトした状態で、**When** アプリを再起動する、**Then** ログイン/登録画面が表示され、再度認証が必要になる
3. **Given** ユーザーが最後にアプリを使用してから30日以上経過した状態で、**When** アプリを起動する、**Then** セッションが期限切れとなり、ログイン/登録画面が表示される

---

### Edge Cases

- **ネットワーク切断時**: ログイン/登録試行中にネットワーク接続が切れた場合、ユーザーフレンドリーなエラーメッセージ「インターネット接続を確認してください」を表示し、再試行オプションを提供する
- **認証サービス障害時**: Firebase Authenticationが一時的に利用できない場合、「一時的にサービスをご利用いただけません。しばらくしてから再度お試しください」というメッセージを表示する
- **同時ログイン**: 同じアカウントで複数デバイスから同時にログインした場合、すべてのデバイスでログイン状態を維持する（セッション競合なし）
- **アカウント削除**: 将来的な機能拡張のため、削除されたアカウントでのログイン試行時に適切なエラーメッセージを表示する必要がある
- **メール確認**: Phase 0では実装しないが、将来的にメールアドレス確認機能を追加する際の考慮事項として記録
- **ブルートフォース攻撃**: 5回連続でログイン失敗した場合、アカウントを15分間ロックし、攻撃者による不正アクセスを防止する。ロック期間中は正しい認証情報でもログインできず、15分経過後に自動的にロックが解除される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは新規ユーザーがメールアドレスとパスワードを使用してアカウントを作成できなければならない
- **FR-002**: システムはメールアドレスの形式を検証し、無効な形式の場合はエラーメッセージを表示しなければならない
- **FR-003**: システムはパスワードが8文字以上であることを検証し、条件を満たさない場合はエラーメッセージを表示しなければならない
- **FR-004**: システムは既に登録されているメールアドレスでの重複登録を防止し、適切なエラーメッセージを表示しなければならない
- **FR-005**: システムは登録済みユーザーが正しいメールアドレスとパスワードでログインできなければならない
- **FR-006**: システムは誤った認証情報でのログイン試行時に、セキュリティを考慮したエラーメッセージ「メールアドレスまたはパスワードが正しくありません」を表示しなければならない
- **FR-007**: システムはGoogleアカウントを使用した新規登録とログインをサポートしなければならない（P2）
- **FR-015**: システムはGoogleサインインが利用不可の場合（サービス障害、ネットワークエラー等）、エラーメッセージ「Googleサインインは現在利用できません。メール/パスワード認証をご利用ください」を表示し、メール/パスワード認証への明確な誘導を提供しなければならない（P2）
- **FR-008**: システムはパスワードリセット機能を提供し、登録済みメールアドレスに1時間有効なリセットリンクを送信しなければならない（P2）
- **FR-009**: システムはログイン状態を永続化し、最後のアクティビティから30日以内であればアプリ再起動時に自動的にログイン状態を復元しなければならない（P3）
- **FR-010**: システムはログアウト機能を提供し、ユーザーが明示的にログアウトできなければならない
- **FR-011**: システムは認証プロセス中にネットワークエラーが発生した場合、ユーザーフレンドリーなエラーメッセージと再試行オプションを提供しなければならない
- **FR-012**: システムは認証中にローディングインジケーターを表示し、ユーザーに処理状態をフィードバックしなければならない
- **FR-013**: システムは認証トークンをOSのセキュアストレージ（iOS Keychain、Android Keystore）に保存し、デバイスレベルのセキュリティで保護しなければならない
- **FR-014**: システムは同一アカウントで5回連続してログインに失敗した場合、15分間そのアカウントをロックし、ユーザーに適切なメッセージ（「セキュリティ上の理由により一時的にログインできません。15分後に再試行してください」）を表示しなければならない

### Key Entities

- **User**: アプリを利用する個人開発者
  - 属性: ユーザーID（一意）、メールアドレス、表示名（オプション）、プロフィール画像URL（オプション）、作成日時、最終ログイン日時
  - 認証方法: メールアドレス/パスワード、Googleアカウント連携
  - 関係性: 将来的にTasks、Projects、DevCoinsエンティティと1対多の関係を持つ

- **Authentication Session**: ユーザーのログイン状態を管理するセッション情報
  - 属性: セッションID、ユーザーID、作成日時、有効期限、デバイス情報（オプション）
  - セキュリティ: トークンベースの認証、自動更新機能

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 新規ユーザーが登録画面から「登録」ボタンをタップしてアカウント作成が完了するまでの時間が30秒以内である
- **SC-002**: 既存ユーザーがログイン画面から「ログイン」ボタンをタップして認証が完了するまでの時間が5秒以内である
- **SC-003**: 登録・ログイン試行の95%以上がエラーなく成功する（ネットワーク問題を除く）
- **SC-004**: 新規ユーザーの90%以上が初回登録試行で成功する（入力ミスによる再試行を1回までカウント）
- **SC-005**: パスワードリセット機能を使用するユーザーの85%以上が、メール受信から新しいパスワードでのログイン成功まで5分以内に完了する
- **SC-006**: Googleサインインを使用するユーザーの認証完了時間が従来のメール/パスワード方式と比較して50%短縮される（P2目標）
- **SC-007**: アプリ再起動時、ログイン状態が維持されているユーザーの98%以上が2秒以内にホーム画面にアクセスできる

## Assumptions

- Firebase Authenticationは安定して利用可能である
- 開発環境ではFirebase Emulator Suiteを使用し、本番環境への影響なくテスト可能である
- ユーザーは有効なメールアドレスを持っている
- Googleサインインを使用するユーザーはGoogleアカウントを既に持っている
- Googleサインインが利用不可の場合、ユーザーはメール/パスワード認証に切り替えてアプリにアクセスできる（外部サービス障害時のフォールバック戦略）
- Phase 0ではメールアドレス確認（Email Verification）は実装せず、将来のPhaseで追加する
- Phase 0では2要素認証（2FA）は実装しないが、アーキテクチャは将来の拡張を考慮する
- パスワードのハッシュ化・暗号化はFirebase Authenticationが自動的に処理する
- セッション管理（トークン更新・有効期限管理）はFirebase SDKが自動的に処理し、30日間のアクティビティなしでセッションが期限切れとなる
- 認証トークンはOSのセキュアストレージ（iOS Keychain、Android Keystore）に保存され、デバイスレベルのセキュリティで保護される

## Dependencies

- Firebase Authentication SDK（Flutter用）
- google_sign_in パッケージ（Googleサインイン用、P2）
- 安定したインターネット接続（認証時必須）
- Googleアカウント（Googleサインイン使用時、P2）

## Out of Scope (Phase 0)

以下の機能は Phase 0 では実装せず、将来のPhaseで検討する:

- メールアドレス確認（Email Verification）
- 2要素認証（2FA / MFA）
- ソーシャルログイン（Google以外：Apple、Twitter、Facebook等）
- パスワード強度メーター
- アカウント削除機能
- プロフィール編集機能（認証後の別機能として実装予定）
- 匿名認証（Guest Login）
- 電話番号認証
