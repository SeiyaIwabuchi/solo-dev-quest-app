# Feature Specification: Phase 3 高度なAI機能

**Feature Branch**: `004-advanced-ai`  
**Created**: 2025-11-01  
**Status**: Draft  
**Input**: User description: "Phase 3: 高度なAI機能"

## User Scenarios & Testing *(mandatory)*

<!--
  CONSTITUTION ALIGNMENT (Principle I & II):
  - すべてのユーザーストーリーは「モチベーション維持」「孤独感解消」「知識不足解決」のいずれかに貢献すること
  - P1ストーリーはMVP（Phase 3）で実装可能な範囲に限定すること
  - 各ストーリーは独立して価値を提供し、Phase間の依存を最小化すること
-->

### User Story 1 - AI仮想クライアントとの定期ミーティング (Priority: P1)

開発者はAI仮想クライアントと定期的なミーティングを行い、プロジェクトの進捗報告、相談、壁打ちができる。クライアントはプロジェクトの状況を理解し、適切なフィードバックや質問を返す。

**Why this priority**: 「孤独感解消」の最重要機能。一人開発の孤独感を軽減し、外部クライアントとの対話を疑似体験できる。

**Independent Test**: ユーザーがAI仮想クライアントとミーティングを開始し、プロジェクト状況に基づいた対話ができることを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** ユーザーがプロジェクトとタスクを登録済み、**When** AI仮想クライアントミーティングを開始する、**Then** 50 DevCoin（または無料：プレミアムプラン）が消費され、クライアントが挨拶とプロジェクト状況の確認を開始する
2. **Given** ミーティング中である、**When** ユーザーが進捗状況を報告する（例：「今週は認証機能を実装しました」）、**Then** AIクライアントが具体的な質問を返す（例：「セキュリティ対策は検討しましたか？」「次のステップは何ですか?」）
3. **Given** ユーザーが技術的な壁に直面している、**When** クライアントに相談する（例：「パフォーマンスが遅い」）、**Then** AIクライアントが質問を通じて問題を掘り下げ、解決の方向性を提案する
4. **Given** ミーティングが終了した、**When** 会話履歴を確認する、**Then** 日時・議題・主な決定事項・次回アクションアイテムが記録されている
5. **Given** プレミアムプラン加入者である、**When** AI仮想クライアントミーティングを開始する、**Then** DevCoin消費なしで無制限に利用できる

---

### User Story 2 - AIクライアントキャラクターのカスタマイズ (Priority: P1)

開発者はAI仮想クライアントの性格・口調・専門分野をカスタマイズし、自分に合った対話スタイルのクライアントを設定できる。

**Why this priority**: クライアントとの対話の質と快適性を高め、ユーザー体験を大幅に向上させる。P1機能の基盤として必須。

**Independent Test**: ユーザーがクライアントの性格を変更し、対話の口調が変化することを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 初回セットアップ時、**When** AIクライアント設定画面を開く、**Then** 性格タイプ（厳格ビジネス/友好的/技術専門家/励まし系等）、口調、専門分野の選択肢が表示される
2. **Given** クライアント設定画面で、**When** 性格を「厳格ビジネス」に設定する、**Then** ミーティング時にフォーマルな口調で質問が投げかけられる（例：「進捗報告をお願いします」）
3. **Given** クライアント設定画面で、**When** 性格を「友好的」に設定する、**Then** ミーティング時にフレンドリーな口調で対話される（例：「調子どう？進んでる？」）
4. **Given** クライアント設定画面で、**When** 専門分野を「モバイルアプリ開発」に設定する、**Then** その分野に関連した質問やフィードバックが優先される
5. **Given** 既存のクライアント設定がある、**When** 設定を変更する、**Then** 次回のミーティングから新しい設定が適用される

---

### User Story 3 - AI説教システム（サボり検知） (Priority: P2)

開発者が一定期間タスクを完了していない、またはログインしていない場合、AIが段階的にエスカレートする説教メッセージ（注意→叱責→失望）を送り、モチベーションを喚起する。

**Why this priority**: 「モチベーション維持」に貢献。褒めシステムの対となる機能で、継続を促進する。

**Independent Test**: ユーザーがタスク未完了期間を経過し、段階的な説教メッセージを受け取ることを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** ユーザーが3日間タスクを完了していない、**When** アプリにログインする、**Then** AI説教システムが「注意」レベルのメッセージを表示する（例：「最近進捗がないようですが、大丈夫ですか?」）
2. **Given** ユーザーが7日間タスクを完了していない、**When** アプリにログインする、**Then** 「叱責」レベルのメッセージが表示される（例：「これでは目標達成できません。今日から再開しましょう」）
3. **Given** ユーザーが14日間タスクを完了していない、**When** アプリにログインする、**Then** 「失望」レベルのメッセージが表示される（例：「本当にこのプロジェクトを完成させる気がありますか?」）
4. **Given** 説教メッセージが表示された、**When** ユーザーが「正当な理由を申告」ボタンを押す、**Then** 理由入力画面が開き、提出後は説教が一時停止される（最長7日間）
5. **Given** 説教メッセージが表示された、**When** ユーザーが20 DevCoinを支払う、**Then** 説教が回避され、次の期間まで表示されない

---

### User Story 4 - AI説教キャラクター性格設定 (Priority: P2)

開発者はAI説教システムのキャラクター性格（厳格師匠、心配する親、同僚友人等）を選択し、自分に合った説教スタイルを設定できる。

**Why this priority**: 説教システムの受容性を高め、ユーザーの離脱を防ぐ。説教機能の基盤上で追加価値を提供。

**Independent Test**: ユーザーが説教キャラクターを変更し、メッセージの口調が変化することを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 説教システム設定画面で、**When** キャラクターを「厳格師匠」に設定する、**Then** 説教メッセージが厳しい口調になる（例：「修行を怠るな！」「甘えは許さん」）
2. **Given** 説教システム設定画面で、**When** キャラクターを「心配する親」に設定する、**Then** 説教メッセージが心配する口調になる（例：「体調は大丈夫？無理してない？」「少しずつでもいいから進めよう」）
3. **Given** 説教システム設定画面で、**When** キャラクターを「同僚友人」に設定する、**Then** 説教メッセージがフレンドリーな口調になる（例：「おーい、サボってるぞー」「一緒に頑張ろうぜ」）
4. **Given** 既存のキャラクター設定がある、**When** 設定を変更する、**Then** 次回の説教メッセージから新しいキャラクターが適用される

---

### User Story 5 - 追加の進捗可視化テーマ（パズル完成） (Priority: P3)

開発者はマラソンランナーに加えて、パズル完成テーマを選択できる。タスク完了ごとにパズルのピースが埋まり、完成すると美しいアート作品が表示される。

**Why this priority**: 「モチベーション維持」を強化。多様な可視化オプションでユーザーの好みに対応し、継続率を向上。

**Independent Test**: ユーザーがパズルテーマを選択し、タスク完了でピースが埋まることを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 設定画面で可視化テーマを選択できる、**When** 「パズル完成」テーマを選択する、**Then** プロジェクト画面にパズルボード（グレーアウトされたピース群）が表示される
2. **Given** パズルテーマが選択されている、**When** タスクを1つ完了する、**Then** パズルのピースが1つ埋まり、AIが褒めメッセージを送る（例：「ピースが1つ埋まりました！素晴らしい！」）
3. **Given** プロジェクトのすべてのタスクが完了した、**When** 最後のパズルピースが埋まる、**Then** 完成したアート作品がアニメーション付きで表示され、特別な祝福メッセージが届く
4. **Given** パズルテーマを使用中、**When** 途中で別のテーマ（マラソンランナー等）に変更する、**Then** 進捗状況は保持され、新しいテーマで同じ進捗率が表示される

---

### User Story 6 - 追加の進捗可視化テーマ（3D都市建設） (Priority: P3)

開発者は3D都市建設テーマを選択できる。タスク達成ごとに建物が建設され、プロジェクト完了時には完成した3D都市が表示される。

**Why this priority**: 可視化テーマのバリエーションを増やし、特に大規模プロジェクトでの達成感を強化。

**Independent Test**: ユーザーが都市建設テーマを選択し、タスク完了で建物が建設されることを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** 設定画面で、**When** 「3D都市建設」テーマを選択する、**Then** プロジェクト画面に空き地が表示され、建設予定地が示される
2. **Given** 都市建設テーマが選択されている、**When** タスクを完了する、**Then** 建物（家、オフィスビル、公園等）が1つ建設され、3Dアニメーションで表示される
3. **Given** 重要度の高いタスク（P1）を完了した、**When** 建物が建設される、**Then** より大きい建物（高層ビル、ランドマーク等）が建設される
4. **Given** プロジェクトが完了した、**When** 最後の建物が建設される、**Then** 完成した3D都市の全景が表示され、カメラがパン・ズームで見回すアニメーションが再生される

---

### User Story 7 - プレミアム可視化テーマの解放 (Priority: P3)

開発者はDevCoinを消費して、プレミアム可視化テーマ（植物育成、宇宙探索、ダンジョン攻略等）を解放し、より多様な進捗可視化を楽しめる。

**Why this priority**: マネタイズとユーザーエンゲージメントの両立。多様なテーマでユーザーの継続率を向上。

**Independent Test**: ユーザーがDevCoinで新しいテーマを購入し、そのテーマを使用できることを確認することで独立して価値を提供する。

**Acceptance Scenarios**:

1. **Given** テーマ選択画面で、**When** プレミアムテーマ（植物育成、宇宙探索等）を閲覧する、**Then** 各テーマの説明・サンプル画像・必要DevCoin（各50-100 DevCoin）が表示される
2. **Given** プレミアムテーマを選択した、**When** 「解放する」ボタンを押す、**Then** 必要DevCoinが消費され、そのテーマが使用可能になる
3. **Given** プレミアムテーマ「植物育成」を解放した、**When** タスクを完了する、**Then** 植物が成長し、継続でより大きく育つ（サボると枯れる演出）
4. **Given** プレミアムテーマ「宇宙探索」を解放した、**When** タスクを完了する、**Then** 宇宙船が進み、新しい惑星を発見するアニメーションが再生される
5. **Given** プレミアムテーマ「ダンジョン攻略」を解放した、**When** タスクを完了する、**Then** ダンジョンの階層を進み、ボス戦完了時に大きな達成感を演出する

---

### Edge Cases

- AI仮想クライアントミーティング中にDevCoinが不足した場合、どうなるか？（ミーティング開始前にチェック）
- ミーティング中にアプリがクラッシュまたはネットワーク切断した場合、会話履歴は保存されるか？
- 説教システムの「正当な理由申告」が乱用された場合、どう対処するか？（申告回数制限）
- 複数のプロジェクトを並行している場合、説教の基準はどのプロジェクトを対象とするか？
- 可視化テーマを変更した場合、既存の進捗データはどう引き継がれるか？
- プレミアムテーマ購入後にアカウントを削除した場合、払い戻しはあるか？
- AI応答の生成が遅延した場合（APIタイムアウト等）、ユーザーにどうフィードバックするか？
- 大量のミーティング履歴が蓄積された場合、ストレージとパフォーマンスはどう管理されるか？
- 説教システムをオフにしたいユーザーへの対応は？（完全無効化オプションの提供）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーが50 DevCoin（またはプレミアムプラン：無料）を消費してAI仮想クライアントミーティングを開始できる機能を提供しなければならない
- **FR-002**: システムは、AI仮想クライアントがユーザーのプロジェクト状況（タスク進捗、完了率等）を理解し、適切な質問・フィードバックを返す対話機能を提供しなければならない
- **FR-003**: システムは、ミーティングの会話履歴を保存し、日時・議題・主な決定事項・次回アクションアイテムを記録しなければならない
- **FR-004**: システムは、AIクライアントの性格タイプ（厳格ビジネス/友好的/技術専門家/励まし系等）、口調、専門分野をカスタマイズできる機能を提供しなければならない
- **FR-005**: システムは、ユーザーのタスク未完了期間に応じて段階的な説教メッセージ（3日：注意、7日：叱責、14日：失望）を送信しなければならない
- **FR-006**: システムは、ユーザーが正当な理由を申告することで説教を最長7日間停止する機能、または20 DevCoinで説教を回避する機能を提供しなければならない
- **FR-007**: システムは、AI説教システムのキャラクター性格（厳格師匠、心配する親、同僚友人等）を選択できる機能を提供しなければならない
- **FR-008**: システムは、進捗可視化テーマとして「パズル完成」「3D都市建設」を追加し、タスク完了ごとにピース埋めまたは建物建設のアニメーションを表示しなければならない
- **FR-009**: システムは、プロジェクト完了時に可視化テーマごとの特別な完成演出（パズル完成アート表示、3D都市全景等）を提供しなければならない
- **FR-010**: システムは、DevCoin消費（各50-100 DevCoin）でプレミアム可視化テーマ（植物育成、宇宙探索、ダンジョン攻略等）を解放できる機能を提供しなければならない
- **FR-011**: システムは、可視化テーマ変更時に進捗データを引き継ぎ、新しいテーマで同じ進捗率を表示しなければならない
- **FR-012**: システムは、タスク重要度（P1/P2/P3）に応じて可視化の演出規模を変化させる機能を提供しなければならない（例：P1タスク完了で大きな建物建設）
- **FR-013**: システムは、説教システムの完全無効化オプションを設定画面で提供しなければならない
- **FR-014**: システムは、AI応答生成の遅延時にローディング表示とタイムアウト処理（30秒以内）を実装しなければならない

### Key Entities

- **VirtualClientMeeting（仮想クライアントミーティング）**: ミーティングID、ユーザーID、開始日時、終了日時、会話履歴（メッセージ配列）、議題、決定事項、アクションアイテム
- **ClientCharacterConfig（クライアントキャラクター設定）**: ユーザーID、性格タイプ、口調スタイル、専門分野、カスタム指示
- **ScoldingEvent（説教イベント）**: イベントID、ユーザーID、発生日時、レベル（注意/叱責/失望）、メッセージ内容、回避方法（理由申告/DevCoin支払い）、ステータス（表示済み/回避済み）
- **ScoldingCharacterConfig（説教キャラクター設定）**: ユーザーID、キャラクタータイプ（厳格師匠/心配する親/同僚友人等）、無効化フラグ
- **VisualizationTheme（可視化テーマ）**: テーマID、テーマ名、説明、種別（無料/プレミアム）、必要DevCoin、サンプル画像URL、アニメーション仕様
- **UserThemeUnlock（ユーザーテーマ解放）**: ユーザーID、テーマID、解放日時、消費DevCoin
- **ProjectVisualizationState（プロジェクト可視化状態）**: プロジェクトID、選択中テーマID、進捗率、テーマ固有データ（パズルピース状態、都市建物リスト等）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: AI仮想クライアントミーティングを利用したユーザーの70%以上が「モチベーションが向上した」と評価する
- **SC-002**: AI仮想クライアント利用者の月間継続率が、非利用者と比較して20%以上高い
- **SC-003**: AI説教システムにより、タスク未完了7日以上のユーザーの50%以上が再開する
- **SC-004**: 追加可視化テーマ利用者のタスク完了率が、デフォルトテーマ利用者と比較して15%以上高い
- **SC-005**: プレミアム可視化テーマの購入率が、アクティブユーザーの10%以上を達成する
- **SC-006**: ミーティング会話履歴は24時間以内にユーザーが再閲覧可能な状態で保存される
- **SC-007**: AI応答生成時間が平均5秒以内であり、95%のケースで10秒以内に完了する

## Assumptions *(mandatory)*

- **A-001**: AI機能はClaude 3.5 Haiku（メイン）とGPT-4o mini（フォールバック）を使用し、Cloud Functions経由で呼び出される（Phase 0で基盤構築済み）
- **A-002**: AI仮想クライアントは1回のミーティングで最大20往復（40メッセージ）の対話を想定する
- **A-003**: ユーザー認証（001-user-auth）、タスク管理（002-task-management）、DevCoin基盤（Phase 1）は既に実装済みである
- **A-004**: 3D可視化テーマはWebGL/Three.js等の3Dライブラリを使用し、モバイル端末で動作可能なパフォーマンスを保つ
- **A-005**: プレミアムテーマの購入はDevCoin消費のみで、アプリ内課金（実通貨）は使用しない

## Dependencies *(mandatory)*

- **D-001**: 001-user-auth（ユーザー認証）- AI機能利用者の識別とセッション管理に必要
- **D-002**: 002-task-management（タスク管理）- タスク進捗データの取得と説教システムの判定基準に必要
- **D-003**: Phase 0 AI褒めシステム - AI応答生成の基盤インフラに依存
- **D-004**: Phase 1 DevCoin購入・消費機能 - ミーティング開始とプレミアムテーマ購入に必要
- **D-005**: Firebase Firestore - 会話履歴、キャラクター設定、可視化状態の永続化に使用
- **D-006**: Firebase Cloud Functions - AI API呼び出しとミーティング処理のサーバーレス実行に使用
- **D-007**: 3Dライブラリ（WebGL/Three.js等） - 3D都市建設テーマの実装に必要

## Out of Scope

- **OOS-001**: AI仮想クライアントとの音声通話機能 - Phase 4以降に検討
- **OOS-002**: 複数の仮想クライアントを同時に設定する機能 - 初期は1クライアントのみ
- **OOS-003**: ユーザー間での可視化テーマのシェア・投稿機能 - 将来的なコミュニティ機能として検討
- **OOS-004**: カスタム可視化テーマの自作機能 - 技術的複雑性が高いため将来検討
- **OOS-005**: 説教システムの機械学習による個別最適化 - 初期は固定ルールベース
- **OOS-006**: AIクライアントのアバター画像生成機能 - Phase 4以降に検討
- **OOS-007**: ミーティング会話の多言語対応 - 将来的な国際展開時に検討

## Notes

- **NOTE-001**: AI仮想クライアント機能はスーパープレミアムプラン（月額1,480円、Phase 4予定）の主要特典として位置づけられるため、Phase 3での実装後、Phase 4でマネタイズモデルを調整する可能性がある
- **NOTE-002**: 3D可視化テーマはモバイル端末のパフォーマンス制約を考慮し、軽量な3Dモデルとアニメーションを使用する必要がある（60fps維持目標）
- **NOTE-003**: AI説教システムは一部ユーザーに不快感を与える可能性があるため、完全無効化オプション（FR-013）を必須とする
- **NOTE-004**: 会話履歴は個人情報を含む可能性があるため、適切な暗号化とアクセス制御を実装する必要がある（プライバシーポリシー対応）
- **NOTE-005**: プレミアム可視化テーマの追加は段階的に行い、ユーザーフィードバックとコミュニティ投票で次回追加テーマを決定する
